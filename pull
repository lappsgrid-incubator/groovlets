import groovy.json.*

String method = request.method

void log(String message) {
	String timestamp = new Date().format('yyyy-MM-dd hh:mm:ss')
	new File('/var/log/groovlets.log').append("[$timestamp] $message\n")
}

if (method != 'POST') {
	log("Invalid request method: $method")
	response.status = 405 // Method not allowed.
	return
}
if (request.contentType != 'application/json') {
	log "Invalid content-type ${request.contentType}"
	response.status = 415  // Unsupported type
	out.println "Accept: application/json"
	return
}

String body = request.inputStream.text
if (!body) {
	log "Empty body"
	response.status = 400 // Bad request
	return
}

def push = new JsonSlurper().parseText(body)

if (push.ref != 'refs/heads/master') {
	log("Pushed to non-master branch ${push.ref}")
	response.status = 200
	return
}

// These are the repositories we are interested in.
Map repos = [ 
	groovlets:'groovlets',
	'jetstream-scripts':'scripts',
	'service-manager-installation':'manager'
]

String name = push.repository.name
String repo = repos[name]
if (repo) {
	StringBuilder buffer = new StringBuilder()
	buffer << "Push to repository ${name}\n"
	buffer << "/var/lib/downloads/scripts/pull.sh $repo".execute().text
	log buffer.toString()
}
else {
	log("Pushed to unsupported repository $name")
}
response.status = 200
