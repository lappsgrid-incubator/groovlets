@Grab("org.anc.json:compiler:1.2.1")
import org.anc.json.compiler.SchemaCompiler
import org.anc.json.compiler.SchemaException

import groovy.json.JsonBuilder
import groovy.json.JsonSlurper

import javax.servlet.http.HttpServletResponse

if (request.method == 'OPTIONS') {
    response.status = 200
    response.addHeader('Allow', 'POST')
    response.addHeader('Accept', 'text/plain')
    out.println "Please POST a LAPPS Alternative Syntax file as text/plain and expect application/json in return."
    return
}

if (request.method != 'POST') {
    response.status = HttpServletResponse.SC_METHOD_NOT_ALLOWED
    response.addHeader('Allow', 'POST')
    return
}

if (request.contentType != 'text/plain') {
    response.status = HttpServletResponse.SC_UNSUPPORTED_MEDIA_TYPE
    response.addHeader('Accept', 'application/json')
    return
}

try {
    SchemaCompiler compiler = new SchemaCompiler()
    compiler.prettyPrint = true
    String json = compiler.compile(request.inputStream.text)
    response.status = 200
    response.addHeader('Content-type', 'application/json')
    out.println json
}
catch (Throwable t) {
    response.status = 500
    out.println t.message
}

