package src.main.groovy

import groovy.json.JsonBuilder
import groovy.util.logging.Slf4j

@GrabConfig(systemClassLoader=true)
@Grab('org.lappsgrid:client:2.0.4')
import org.lappsgrid.client.*

import groovy.json.JsonSlurper
@Grab('ch.qos.logback:logback-classic:1.2.3')
@Grab('org.slf4j:slf4j-simple:1.7.25')
import org.slf4j.Logger

import javax.servlet.http.HttpServletResponse

log("Servicing request.")
if (request.method == 'OPTIONS') {
    response.status = 200
    response.addHeader('Allow', 'POST')
    response.addHeader('Accept', 'application/json, text/plain')
    return
}

if (request.method != 'POST') {
    response.status = HttpServletResponse.SC_METHOD_NOT_ALLOWED
    response.addHeader('Allow', 'POST')
    out.println "Method ${request.method} not allowed. Please send a POST request."
    warn "Not a POST"
    return
}

if (params.id == null) {
    response.status = 400
    out.println "No service ID provided."
    return
}

String url = 'http://eldrad.cs-i.brandeis.edu:8080/service_manager/invoker/'
if (params.id.startsWith("anc:")) {
    url = 'http://vassar.lappsgrid.org/invoker/'
}
url += params.id

String text = request.inputStream.text
if (text == null || text == '') {
    response.status = 400
    out.println "No text was posted."
    return
}

String username = 'tester'
String password = 'tester'


log "Proxying ${url}"

ServiceClient client = new ServiceClient(url, username, password)
String json = client.execute(text)
response.status = 200
response.contentType = 'application/json'
out.println groovy.json.JsonOutput.prettyPrint(json)
log "Request serviced."
return

void debug(String message) {
    Log.logger.debug(message)
}
void log(String message) {
    Log.logger.info(message)
}
void warn(String message) {
    Log.logger.warn(message)
}
void error(String message) {
    Log.logger.error(message)
}
@Slf4j('log')
class Log {
    static Logger getLogger() {
        return log
    }
}
