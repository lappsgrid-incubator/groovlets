package src.main.groovy

@GrabConfig(systemClassLoader=true)
@Grab('org.lappsgrid:client:2.0.4')
import org.lappsgrid.client.*

import groovy.json.JsonBuilder
import groovy.json.JsonSlurper

import javax.servlet.http.HttpServletResponse

if (request.method == 'OPTIONS') {
    response.status = 200
    response.addHeader('Allow', 'POST')
    response.addHeader('Accept', 'application/json')
    return
}

if (request.method != 'POST') {
    response.status = HttpServletResponse.SC_METHOD_NOT_ALLOWED
    response.addHeader('Allow', 'POST')
    return
}

if (request.contentType != 'application/json') {
    response.status = HttpServletResponse.SC_UNSUPPORTED_MEDIA_TYPE
    response.addHeader('Accept', 'application/json')
    return
}

Map headers = request.headers
String url = headers.url
String username = headers.username
String password = headers.password

def parser = new JsonSlurper()
Map input = (Map) parser.parse(request.inputStream)
if (url == null) {
    if (input.url == null) {
        response.status = HttpServletResponse.SC_BAD_REQUEST
        out.println "No service URL provided."
        return
    }
    url = input.url
}
if (input.data == null) {
    response.status = HttpServletResponse.SC_BAD_REQUEST
    out.println "No data proviced."
    return
}

if (username == null) {
    username = input.username ?: 'tester'
}
if (password == null) {
    password = input.password ?: 'tester'
}

ServiceClient client = new ServiceClient(input.url, username, password)
String json = client.execute(new JsonBuilder(input.data).toString())
response.status = 200
response.contentType = 'application/json'

out.println groovy.json.JsonOutput.prettyPrint(json)

